AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'PurposePath Shared Infrastructure - VPC, DynamoDB, Redis, Custom Domain, S3, CloudWatch'

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Deployment stage

  DomainName:
    Type: String
    Default: api.dev.purposepath.app
    Description: Custom domain name for APIs

  HostedZoneId:
    Type: String
    Default: ''
    Description: Route53 Hosted Zone ID for purposepath.app (required for custom domain)

  RedisNodeType:
    Type: String
    Default: cache.t3.micro
    AllowedValues:
      - cache.t3.micro
      - cache.t3.small
      - cache.t3.medium
    Description: ElastiCache Redis node type

  JwtSecretArn:
    Type: String
    Default: ''
    Description: ARN of JWT Secret in Secrets Manager (will create if empty)

  EmailFrom:
    Type: String
    Default: noreply@purposepath.ai
    Description: From email address for notifications

Conditions:
  CreateJwtSecret: !Equals
    - !Ref JwtSecretArn
    - ''
  IsProduction: !Equals
    - !Ref Stage
    - prod
  CreateCustomDomain: !Not
    - !Equals
      - !Ref HostedZoneId
      - ''

Resources:
  # ==========================================
  # VPC Infrastructure
  # ==========================================

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub purposepath-vpc-${Stage}
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub purposepath-igw-${Stage}
        - Key: Application
          Value: PurposePath

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet for NAT Gateway
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.0.0/24
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub purposepath-public-subnet-${Stage}
        - Key: Application
          Value: PurposePath

  # Private Subnets for Lambda
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub purposepath-private-subnet-1-${Stage}
        - Key: Application
          Value: PurposePath

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select
        - 1
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub purposepath-private-subnet-2-${Stage}
        - Key: Application
          Value: PurposePath

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub purposepath-public-rt-${Stage}
        - Key: Application
          Value: PurposePath

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # NAT Gateway for Lambda Internet Access
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub purposepath-nat-eip-${Stage}
        - Key: Application
          Value: PurposePath

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: !Sub purposepath-nat-${Stage}
        - Key: Application
          Value: PurposePath

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub purposepath-private-rt-${Stage}
        - Key: Application
          Value: PurposePath

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # VPC Endpoints for AWS Services (Cost Optimization)
  DynamoDBEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.dynamodb
      RouteTableIds:
        - !Ref PrivateRouteTable

  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      RouteTableIds:
        - !Ref PrivateRouteTable

  # Security Groups
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub purposepath-lambda-sg-${Stage}
        - Key: Application
          Value: PurposePath

  RedisSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Redis cluster
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub purposepath-redis-sg-${Stage}
        - Key: Application
          Value: PurposePath

  # ==========================================
  # S3 Buckets
  # ==========================================

  ApplicationBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub purposepath-app-${Stage}-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: !If
          - IsProduction
          - Enabled
          - Suspended
      LifecycleConfiguration:
        Rules:
          - Id: DeleteIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage

  LogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub purposepath-logs-${Stage}-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: !If
              - IsProduction
              - 90
              - 30
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage

  # ==========================================
  # JWT Secret (if not provided)
  # ==========================================

  JwtSecret:
    Type: AWS::SecretsManager::Secret
    Condition: CreateJwtSecret
    Properties:
      Name: !Sub purposepath/jwt-secret/${Stage}
      Description: JWT signing secret for PurposePath authentication
      GenerateSecretString:
        SecretStringTemplate: '{}'
        GenerateStringKey: secret
        PasswordLength: 64
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage

  # ==========================================
  # Custom Domain and Certificates
  # ==========================================

  ApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: CreateCustomDomain
    Properties:
      DomainName: !Ref DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZoneId
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage

  ApiDomain:
    Type: AWS::ApiGatewayV2::DomainName
    Condition: CreateCustomDomain
    Properties:
      DomainName: !Ref DomainName
      DomainNameConfigurations:
        - CertificateArn: !Ref ApiCertificate
          EndpointType: REGIONAL
      Tags:
        Application: PurposePath
        Stage: !Ref Stage

  ApiARecord:
    Type: AWS::Route53::RecordSet
    Condition: CreateCustomDomain
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt ApiDomain.RegionalDomainName
        HostedZoneId: !GetAtt ApiDomain.RegionalHostedZoneId

  # ==========================================
  # DynamoDB Tables - Core Authentication
  # ==========================================

  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-users-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: email
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: email-index
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: created-at-index
          KeySchema:
            - AttributeName: id
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: tenant-id-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If
          - IsProduction
          - true
          - false
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: Authentication

  RefreshTokensTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-refresh-tokens-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: jti
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: expires_at
          AttributeType: N
      KeySchema:
        - AttributeName: jti
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: expiration-index
          KeySchema:
            - AttributeName: jti
              KeyType: HASH
            - AttributeName: expires_at
              KeyType: RANGE
          Projection:
            ProjectionType: KEYS_ONLY
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: Authentication

  PasswordResetsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-password-resets-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: token_hash
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: token_hash
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: Authentication

  VerificationTokensTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-verification-tokens-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: token_hash
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: token_hash
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: Authentication

  # ==========================================
  # DynamoDB Tables - Multitenant
  # ==========================================

  TenantsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-tenants-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: domain
          AttributeType: S
      KeySchema:
        - AttributeName: tenant_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: domain-index
          KeySchema:
            - AttributeName: domain
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If
          - IsProduction
          - true
          - false
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: TenantManagement

  SubscriptionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-subscriptions-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: subscription_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
      KeySchema:
        - AttributeName: subscription_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: tenant_id-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If
          - IsProduction
          - true
          - false
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: SubscriptionManagement

  InvitationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-invitations-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: invitation_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: invitation_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: tenant_id-status-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: email-status-index
          KeySchema:
            - AttributeName: email
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: InvitationManagement

  # ==========================================
  # DynamoDB Tables - Business Data
  # ==========================================

  BusinessDataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-business-data-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: business_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: version
          AttributeType: S
      KeySchema:
        - AttributeName: business_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: tenant_id-version-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
            - AttributeName: version
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If
          - IsProduction
          - true
          - false
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: BusinessData

  CoachingSessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-coaching-sessions-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: session_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: topic
          AttributeType: S
        - AttributeName: started_at
          AttributeType: S
      KeySchema:
        - AttributeName: session_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: tenant_id-user_id-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
            - AttributeName: user_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: user_id-topic-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: topic
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: tenant_id-started_at-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
            - AttributeName: started_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If
          - IsProduction
          - true
          - false
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: CoachingData

  ConversationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-conversations-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: conversation_id
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
      KeySchema:
        - AttributeName: conversation_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: tenant_id-user_id-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
            - AttributeName: user_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: user_id-created_at-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If
          - IsProduction
          - true
          - false
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: ConversationData

  UserPreferencesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub purposepath-user-preferences-${Stage}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: tenant_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: tenant_id-index
          KeySchema:
            - AttributeName: tenant_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage
        - Key: DataType
          Value: UserPreferences

  # ==========================================
  # ElastiCache Redis Cluster
  # ==========================================

  RedisSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Subnet group for PurposePath Redis cluster
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  RedisCluster:
    Type: AWS::ElastiCache::ReplicationGroup
    Properties:
      ReplicationGroupId: !Sub purposepath-redis-${Stage}
      ReplicationGroupDescription: Redis cluster for PurposePath session management
      NumCacheClusters: !If
        - IsProduction
        - 3
        - 2
      Engine: redis
      CacheNodeType: !Ref RedisNodeType
      CacheSubnetGroupName: !Ref RedisSubnetGroup
      SecurityGroupIds:
        - !Ref RedisSecurityGroup
      AtRestEncryptionEnabled: !If
        - IsProduction
        - true
        - false
      TransitEncryptionEnabled: !If
        - IsProduction
        - true
        - false
      MultiAZEnabled: !If
        - IsProduction
        - true
        - false
      AutomaticFailoverEnabled: !If
        - IsProduction
        - true
        - false
      Tags:
        - Key: Application
          Value: PurposePath
        - Key: Stage
          Value: !Ref Stage

  # ==========================================
  # CloudWatch Dashboard
  # ==========================================

  ApplicationDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub purposepath-dashboard-${Stage}
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/Lambda", "Invocations", "FunctionName", "purposepath-account-api-${Stage}" ],
                  [ ".", "Errors", ".", "." ],
                  [ ".", "Duration", ".", "." ],
                  [ ".", "Throttles", ".", "." ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Account Service Lambda Metrics"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/ApiGateway", "Count", "ApiId", "AccountHttpApi" ],
                  [ ".", "4XXError", ".", "." ],
                  [ ".", "5XXError", ".", "." ],
                  [ ".", "Latency", ".", "." ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "API Gateway Metrics"
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 24,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${UsersTable}" ],
                  [ ".", "ConsumedWriteCapacityUnits", ".", "." ],
                  [ ".", "UserErrors", ".", "." ],
                  [ ".", "SystemErrors", ".", "." ]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB Metrics"
              }
            }
          ]
        }

Outputs:
  # ==========================================
  # VPC and Network Exports
  # ==========================================
  VpcId:
    Description: VPC ID for PurposePath infrastructure
    Value: !Ref VPC
    Export:
      Name: !Sub purposepath-vpc-id-${Stage}

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub purposepath-private-subnet-1-${Stage}

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub purposepath-private-subnet-2-${Stage}

  LambdaSecurityGroupId:
    Description: Security Group ID for Lambda functions
    Value: !Ref LambdaSecurityGroup
    Export:
      Name: !Sub purposepath-lambda-sg-${Stage}

  # ==========================================
  # S3 Bucket Exports
  # ==========================================
  ApplicationBucket:
    Description: S3 bucket for application data
    Value: !Ref ApplicationBucket
    Export:
      Name: !Sub purposepath-app-bucket-${Stage}

  LogsBucket:
    Description: S3 bucket for logs
    Value: !Ref LogsBucket
    Export:
      Name: !Sub purposepath-logs-bucket-${Stage}

  # ==========================================
  # Secret and Domain Exports
  # ==========================================
  JwtSecretArn:
    Description: ARN of JWT Secret
    Value: !If
      - CreateJwtSecret
      - !Ref JwtSecret
      - !Ref JwtSecretArn
    Export:
      Name: !Sub purposepath-jwt-secret-arn-${Stage}

  CustomDomainName:
    Description: Custom domain name
    Value: !Ref DomainName
    Export:
      Name: !Sub purposepath-domain-name-${Stage}

  ApiCertificateArn:
    Condition: CreateCustomDomain
    Description: SSL Certificate ARN for API domain
    Value: !Ref ApiCertificate
    Export:
      Name: !Sub purposepath-certificate-arn-${Stage}

  ApiDomainName:
    Condition: CreateCustomDomain
    Description: API Gateway custom domain name
    Value: !Ref ApiDomain
    Export:
      Name: !Sub purposepath-api-domain-${Stage}

  # ==========================================
  # DynamoDB Table Exports - Authentication
  # ==========================================
  UsersTableName:
    Description: DynamoDB Users Table Name
    Value: !Ref UsersTable
    Export:
      Name: !Sub purposepath-users-table-${Stage}

  UsersTableArn:
    Description: DynamoDB Users Table ARN
    Value: !GetAtt UsersTable.Arn
    Export:
      Name: !Sub purposepath-users-table-arn-${Stage}

  RefreshTokensTableName:
    Description: DynamoDB Refresh Tokens Table Name
    Value: !Ref RefreshTokensTable
    Export:
      Name: !Sub purposepath-refresh-tokens-table-${Stage}

  RefreshTokensTableArn:
    Description: DynamoDB Refresh Tokens Table ARN
    Value: !GetAtt RefreshTokensTable.Arn
    Export:
      Name: !Sub purposepath-refresh-tokens-table-arn-${Stage}

  PasswordResetsTableName:
    Description: DynamoDB Password Resets Table Name
    Value: !Ref PasswordResetsTable
    Export:
      Name: !Sub purposepath-password-resets-table-${Stage}

  PasswordResetsTableArn:
    Description: DynamoDB Password Resets Table ARN
    Value: !GetAtt PasswordResetsTable.Arn
    Export:
      Name: !Sub purposepath-password-resets-table-arn-${Stage}

  VerificationTokensTableName:
    Description: DynamoDB Verification Tokens Table Name
    Value: !Ref VerificationTokensTable
    Export:
      Name: !Sub purposepath-verification-tokens-table-${Stage}

  VerificationTokensTableArn:
    Description: DynamoDB Verification Tokens Table ARN
    Value: !GetAtt VerificationTokensTable.Arn
    Export:
      Name: !Sub purposepath-verification-tokens-table-arn-${Stage}

  # ==========================================
  # DynamoDB Table Exports - Multitenant
  # ==========================================
  TenantsTableName:
    Description: DynamoDB Tenants Table Name
    Value: !Ref TenantsTable
    Export:
      Name: !Sub purposepath-tenants-table-${Stage}

  TenantsTableArn:
    Description: DynamoDB Tenants Table ARN
    Value: !GetAtt TenantsTable.Arn
    Export:
      Name: !Sub purposepath-tenants-table-arn-${Stage}

  SubscriptionsTableName:
    Description: DynamoDB Subscriptions Table Name
    Value: !Ref SubscriptionsTable
    Export:
      Name: !Sub purposepath-subscriptions-table-${Stage}

  SubscriptionsTableArn:
    Description: DynamoDB Subscriptions Table ARN
    Value: !GetAtt SubscriptionsTable.Arn
    Export:
      Name: !Sub purposepath-subscriptions-table-arn-${Stage}

  InvitationsTableName:
    Description: DynamoDB Invitations Table Name
    Value: !Ref InvitationsTable
    Export:
      Name: !Sub purposepath-invitations-table-${Stage}

  InvitationsTableArn:
    Description: DynamoDB Invitations Table ARN
    Value: !GetAtt InvitationsTable.Arn
    Export:
      Name: !Sub purposepath-invitations-table-arn-${Stage}

  # ==========================================
  # DynamoDB Table Exports - Business Data
  # ==========================================
  BusinessDataTableName:
    Description: DynamoDB Business Data Table Name
    Value: !Ref BusinessDataTable
    Export:
      Name: !Sub purposepath-business-data-table-${Stage}

  BusinessDataTableArn:
    Description: DynamoDB Business Data Table ARN
    Value: !GetAtt BusinessDataTable.Arn
    Export:
      Name: !Sub purposepath-business-data-table-arn-${Stage}

  CoachingSessionsTableName:
    Description: DynamoDB Coaching Sessions Table Name
    Value: !Ref CoachingSessionsTable
    Export:
      Name: !Sub purposepath-coaching-sessions-table-${Stage}

  CoachingSessionsTableArn:
    Description: DynamoDB Coaching Sessions Table ARN
    Value: !GetAtt CoachingSessionsTable.Arn
    Export:
      Name: !Sub purposepath-coaching-sessions-table-arn-${Stage}

  ConversationsTableName:
    Description: DynamoDB Conversations Table Name
    Value: !Ref ConversationsTable
    Export:
      Name: !Sub purposepath-conversations-table-${Stage}

  ConversationsTableArn:
    Description: DynamoDB Conversations Table ARN
    Value: !GetAtt ConversationsTable.Arn
    Export:
      Name: !Sub purposepath-conversations-table-arn-${Stage}

  UserPreferencesTableName:
    Description: DynamoDB User Preferences Table Name
    Value: !Ref UserPreferencesTable
    Export:
      Name: !Sub purposepath-user-preferences-table-${Stage}

  UserPreferencesTableArn:
    Description: DynamoDB User Preferences Table ARN
    Value: !GetAtt UserPreferencesTable.Arn
    Export:
      Name: !Sub purposepath-user-preferences-table-arn-${Stage}

  # ==========================================
  # Redis Exports
  # ==========================================
  RedisClusterEndpoint:
    Description: Redis Cluster Primary Endpoint
    Value: !GetAtt RedisCluster.PrimaryEndPoint.Address
    Export:
      Name: !Sub purposepath-redis-endpoint-${Stage}

  RedisClusterPort:
    Description: Redis Cluster Port
    Value: !GetAtt RedisCluster.PrimaryEndPoint.Port
    Export:
      Name: !Sub purposepath-redis-port-${Stage}

  # ==========================================
  # Other Exports
  # ==========================================
  EmailFrom:
    Description: From email address for notifications
    Value: !Ref EmailFrom
    Export:
      Name: !Sub purposepath-email-from-${Stage}

  Stage:
    Description: Deployment stage
    Value: !Ref Stage
    Export:
      Name: !Sub purposepath-stage-${Stage}